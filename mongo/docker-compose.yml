version: "3.8"
services:
  mongodb:
    build: 
      context: ./mongo
      args:
        INIT_COLLECTION_URL: https://raw.githubusercontent.com/budavariam/mongodb-sample-dataset/main/sample_airbnb/listingsAndReviews.json
    container_name: mongodb
    environment:
    - MONGO_INITDB_ROOT_USERNAME=$ROOT_USER
    - MONGO_INITDB_ROOT_PASSWORD=$ROOT_PASS
    - MONGO_INITDB_DATABASE=airbnb # tell thee mongo image to create this db
    - INIT_COLLECTION=listingsAndReviews # tell the init script to use this collection
    volumes:
      - ./mongodb-data:/data/db # persist db in a local folder
      - ./docker-entrypoint-initdb.d/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro # init db on start
    # networks:
    # - mongodb_network
    ports:
    - 27017:27017
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
  mongo-express:
    image: mongo-express
    container_name: mongo-express
    environment:
    - ME_CONFIG_MONGODB_SERVER=mongodb
    - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
    - ME_CONFIG_MONGODB_ADMINUSERNAME=$ROOT_USER
    - ME_CONFIG_MONGODB_ADMINPASSWORD=$ROOT_PASS
    - ME_CONFIG_BASICAUTH_USERNAME=$GUI_AUTH_USER
    - ME_CONFIG_BASICAUTH_PASSWORD=$GUI_AUTH_PASS
    depends_on:
    - mongodb
    # networks:
    # - mongodb_network
    ports:
    - 8081:8081
    healthcheck:
      test:  wget --quiet --tries=3 --spider http://$GUI_AUTH_USER:$GUI_AUTH_PASS@localhost:8081 || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
# volumes:
#   mongodb-data:
#     name: mongodb-data
# networks:
#   mongodb_network:
#     name: mongodb_network